---
alwaysApply: true
---

# プロジェクト仕様

## 概要
日本の地方プロボノマッチングアプリケーション"じもプロ"

## プロジェクトの目的
- 地方貢献に興味のある人材が、地方の中小企業や自治体のプロジェクトに応募することによって、プロボノマッチングを実現
- 求人は地方の中小企業や自治体が自ら書く。ガチガチの要件（納期や仕様）を書かせるのではなく、「想い」や「現状のモヤモヤ」を書いてもらうようにすることで、業務の切り出しの負荷を下げる。
- ログインしていないユーザーでも、どのような案件があるのかわかるようなサイトのUX。ログインしていないユーザーが応募するときには、ログインまたは会員登録が必要
- AIを活用したプロジェクト投稿フォーム入力補助機能（将来的に）
- 地方貢献に興味のある人材に対して、地方の中小企業や自治体がスカウトを送りマッチングする機能（将来的に）

## 技術スタック
- Laravel 12.x
- Livewire 3 + Volt (Functional)
- Flux UI Free
- Tailwind CSS v4
- Pest v4

## 認証システム
- Laravel Fortifyベースの認証（Livewire Starter Kit）
- 2要素認証対応
- セッション管理

## ルーティング規約
- リソースルート: 複数形（例: `/jobs`, `/applications`）
- 機能別ルート: 適切な命名（例: `/dashboard`, `/settings`）
- 認証必須ルート: `auth`ミドルウェア使用
- 名前付きルート必須

## ロール機能

### ユーザーロール
- `company`: 企業ユーザー（求人投稿、応募管理）
- `worker`: ワーカーユーザー（求人応募、応募一覧）

### ロールベースミドルウェア
- ミドルウェア名: `role`
- 実装クラス: `App\Http\Middleware\EnsureUserHasRole`
- 使用方法: `->middleware('role:company')` または `->middleware('role:worker')`
- 不正アクセス時: 403エラー（Access Denied）

### ログイン後のリダイレクト
- すべてのユーザー: `/dashboard` にリダイレクト
- プロフィール登録の有無に関わらず共通

## UI設計ルール

### 未実装機能へのリンク表示
段階的な実装を進める際（詳細画面→編集画面→登録画面の順）、未実装機能へのリンクには以下のルールを適用：

- 未実装機能へのリンクには「（準備中）」の文言を追加
- リンクは無効化する（`disabled` 属性を使用）
- 実装完了後、「（準備中）」を削除し、正しいリンクを設定

**実装例**:
```blade
<!-- 未実装時 -->
<flux:button disabled>
    編集（準備中）
</flux:button>

<!-- 実装後 -->
<flux:button :href="route('jobs.edit', $job)" wire:navigate>
    編集
</flux:button>
```

**実装手順**:
1. 詳細画面作成時：編集・削除ボタンを「（準備中）」で実装
2. 編集画面作成時：編集ボタンを有効化、「（準備中）」を削除
3. 登録画面作成時：新規作成ボタンを有効化、「（準備中）」を削除

## ポリシーと認可
- 各モデルに対応するPolicyクラス作成
- アクション実行前の認可チェック必須
- `$this->authorize()`メソッド使用

## バリデーション
- Form Requestクラス使用必須
- インラインバリデーション禁止
- 日本語エラーメッセージ
- カスタムバリデーションルールは適切に分離

---

## 機能要件詳細

### 認証・アカウント管理

#### ログイン
- **ルート**: `GET/POST /login`
- **コンポーネント**: Fortify標準
- **機能**: メールアドレスとパスワードでログイン

#### ユーザー登録
- **ルート**: `GET/POST /register`
- **コンポーネント**: Fortify標準
- **機能**: 新規アカウント作成

#### パスワードリセット
- **ルート**: `GET/POST /password/reset`
- **コンポーネント**: Fortify標準
- **機能**: メール経由でのパスワードリセット

#### 2要素認証
- **ルート**: `/settings/two-factor`
- **コンポーネント**: `resources/views/livewire/settings/two-factor.blade.php`
- **機能**: 2FAの有効化・無効化、リカバリーコード管理

### 企業プロフィール管理

#### 企業登録画面
- **ルート**: `GET /company/register`、`POST /company/register`
- **ルート名**: `company.register`
- **コンポーネント**: `resources/views/livewire/company/register.blade.php`
- **ミドルウェア**: `auth`（認証済みユーザー向け）
- **機能**: 認証済みユーザーの企業プロフィール登録
- **入力項目**:
  - icon: アイコン画像(任意、画像アップロード)
  - location_id: 所在地（必須、2段階選択：都道府県→市区町村）
  - address: 所在地住所（必須、200文字以内）
  - representative: 担当者名（必須、50文字以内）
  - phone_number: 電話番号（必須、30文字以内）
- **処理**:
  - company_profilesテーブルにプロフィール登録
  - 登録成功後、企業詳細画面（company.profile）にリダイレクト
- **UI**:
  - 企業プロフィール情報のみを入力
  - 2段階選択（都道府県→市区町村）の実装
  - パソコン操作が苦手な事業者でもスマホで入力できるようにレスポンシブ対応する
- **注意**: 
  - ユーザー登録は事前にFortifyの標準登録画面で完了している前提
  - 既にプロフィールが登録されている場合は企業詳細画面にリダイレクト

#### 企業詳細画面
- **ルート**: `GET /company/profile`
- **ルート名**: `company.profile`
- **コンポーネント**: `resources/views/livewire/company/show.blade.php`
- **ミドルウェア**: `auth`, `role:company`
- **機能**: ログインユーザーの企業プロフィール表示
- **表示項目**: company_profilesテーブルの全項目
  - アイコン画像（丸くマスクした事業者ロゴ画像）
  - 企業名（users.name）
  - 所在地（都道府県 市区町村、例：東京都 千代田区）
  - 所在地住所
  - 担当者名
  - 担当者連絡先
  - 登録日時
  - 更新日時
- **アクション**: 編集画面へのリンク

#### 企業編集画面
- **ルート**: `GET /company/edit`
- **ルート名**: `company.edit`
- **コンポーネント**: `resources/views/livewire/company/edit.blade.php`
- **ミドルウェア**: `auth`, `role:company`
- **機能**: ログインユーザーの企業プロフィール編集
- **入力項目**: 企業プロフィール項目のみ（location_id, address, representative, phone_number）
- **処理**:
  - バリデーション後、company_profilesテーブルを更新
  - 更新成功後、企業詳細画面（company.profile）にリダイレクト
- **UI**:
  - 既存データを初期表示
  - 2段階選択（都道府県→市区町村）の実装
  - パソコン操作が苦手な事業者でもスマホで入力できるようにレスポンシブ対応する
- **注意**: 企業名（users.name）の変更は別途ユーザー情報編集機能で対応

#### 所在地の2段階選択仕様
- **都道府県選択**:
  - locationsテーブルから`city IS NULL`のデータを取得
  - `code`の昇順でソート
- **市区町村選択**:
  - 選択された都道府県に対応する市区町村を取得
  - `prefecture`が選択された都道府県と一致し、`city IS NOT NULL`のデータ
  - `code`の昇順でソート
- **連動動作**:
  - 都道府県を変更すると、市区町村の選択肢が更新される
  - 都道府県を変更すると、市区町村の選択はリセットされる

### ワーカープロフィール管理

#### ワーカー登録画面
- **ルート**: `GET /worker/register`、`POST /worker/register`
- **ルート名**: `worker.register`
- **コンポーネント**: `resources/views/livewire/worker/register.blade.php`
- **ミドルウェア**: なし（未認証ユーザー向け）
- **機能**: ユーザー登録とワーカープロフィールを同時登録
- **入力項目**:
  - name: 氏名（必須）
  - handle_name: ハンドルネーム（必須）
  - email: メールアドレス（必須、ユニーク）
  - password: パスワード（必須、8文字以上）
  - password_confirmation: パスワード確認（必須）
  - icon: アイコン画像(任意、画像アップロード)
  - gender: 性別（必須、ラジオボタン：male, female, other）
  - birthdate: 生年月日（必須、年月日ドロップダウン）
  - experiences: これまでの経験（任意、日本語200文字以内、テキストエリア）
  - want_to_do: これからやりたいこと（任意、日本語200文字以内、テキストエリア）
  - good_contribution: 得意なことや貢献できること（任意、日本語200文字以内、テキストエリア）
  - birth_location_id: 出身地（必須、2段階選択：都道府県→市区町村）
  - current_location_1_id: 現在のお住まい1（必須、2段階選択：都道府県→市区町村）
  - current_location_2_id: 現在のお住まい2（任意、2段階選択：都道府県→市区町村）
  - favorite_location_1_id: 移住に関心のある地域1（任意、2段階選択：都道府県→市区町村）
  - favorite_location_2_id: 移住に関心のある地域2（任意、2段階選択：都道府県→市区町村）
  - favorite_location_3_id: 移住に関心のある地域3（任意、2段階選択：都道府県→市区町村）
  - available_action: 興味のあるお手伝い（任意、チェックボックス:mowing, snowplow, diy, localcleaning, volunteer）
- **処理**:
  - usersテーブルにユーザー登録（role='worker'、name=氏名）
  - worker_profilesテーブルにプロフィール登録
  - 登録成功後、ワーカー詳細画面（worker.profile）にリダイレクト
- **UI**:
  - ユーザー情報とワーカープロフィール情報を1画面で入力
  - 年月日ドロップダウンの動的生成
  - 2段階選択（都道府県→市区町村、任意）の実装

#### ワーカー詳細画面
- **ルート**: `GET /worker/profile`
- **ルート名**: `worker.profile`
- **コンポーネント**: `resources/views/livewire/worker/show.blade.php`
- **ミドルウェア**: `auth`, `role:worker`
- **機能**: ログインユーザーのワーカープロフィール表示
- **表示項目**: worker_profilesテーブルの全項目
  - ハンドルネーム（handles.name）
  - アイコン画像（丸くマスクしたプロフィール画像）
  - 性別（日本語表示：male=男性、female=女性、other=その他）
  - 生年月日と年齢（例：1990年5月15日（34歳））
  - これまでの経験(200文字までのテキスト)
  - これからやりたいこと(200文字までのテキスト)
  - 得意なことや貢献できること(200文字までのテキスト)
  - 現在のお住まい1（都道府県 市区町村、NULL時は「未設定」）
  - 現在のお住まい2（都道府県 市区町村、NULL時は「未設定」）
  - 移住に関心のある地域1（都道府県 市区町村、NULL時は「未設定」）
  - 移住に関心のある地域2（都道府県 市区町村、NULL時は「未設定」）
  - 移住に関心のある地域3（都道府県 市区町村、NULL時は「未設定」）
  - 興味のあるお手伝い（複数選択可能、日本語表示:mowing=草刈り, snowplow=雪かき, localcleaning=地域清掃, diy=DIY, volunteer=災害ボランティア）
  - 登録日時
  - 更新日時
- **アクション**: 編集画面へのリンク

#### ワーカー編集画面
- **ルート**: `GET /worker/edit`
- **ルート名**: `worker.edit`
- **コンポーネント**: `resources/views/livewire/worker/edit.blade.php`
- **ミドルウェア**: `auth`, `role:worker`
- **機能**: プロフィール編集
- **入力項目**: ワーカープロフィール項目のみ（gender, birthdate, skills, experiences, desired_jobs, desired_location_id）
- **処理**:
  - バリデーション後、worker_profilesテーブルを更新
  - 更新成功後、ワーカー詳細画面（worker.profile）にリダイレクト
- **注意**: 氏名（users.name）の変更は別途ユーザー情報編集機能で対応

#### 生年月日の年月日選択仕様
- **年選択**: 現在年 - 18歳 から 現在年 - 80歳 まで（降順）
- **月選択**: 1月〜12月
- **日選択**: 選択された年月に応じて動的に生成
  - 1, 3, 5, 7, 8, 10, 12月: 1〜31日
  - 4, 6, 9, 11月: 1〜30日
  - 2月: 閏年判定（28日または29日）
- **連動動作**:
  - 年または月を変更すると、日の選択肢が更新される
  - 選択中の日が新しい日数を超える場合、日選択はリセット

#### 地域の2段階選択仕様（任意）
- **都道府県選択**:
  - locationsテーブルから`city IS NULL`のデータを取得
  - `code`の昇順でソート
  - 「選択しない」オプションあり
- **市区町村選択**:
  - 選択された都道府県に対応する市区町村を取得
  - `prefecture`が選択された都道府県と一致し、`city IS NOT NULL`のデータ
  - `code`の昇順でソート
  - 「選択しない」オプションあり
- **連動動作**:
  - 都道府県を変更すると、市区町村の選択肢が更新される
  - 都道府県を変更すると、市区町村の選択はリセットされる
  - 都道府県を「選択しない」にすると、市区町村も「選択しない」になる
 
 - **アクション**:
   - 企業ユーザーのみ: 「新規募集投稿」ボタン表示（jobs.create へ遷移）
   - 全求人カード: クリックで募集詳細画面（jobs.show）へ遷移
 - **リレーション**:
   - company（企業）、location_id（所在地）を先読み込み（N+1問題回避）
 
 #### 求人詳細画面
 - **ルート**: `GET /jobs/{jobPost}`
 - **ルート名**: `jobs.show`
 - **コンポーネント**: `resources/views/livewire/jobs/show.blade.php`
 - **ミドルウェア**: `auth`
 - **機能**: 募集詳細表示、応募ボタン、編集・削除ボタン
 - **表示内容**:
   - job_postsテーブルの全情報
   - リレーション情報（企業名、所在地）
 - **アクション**:
   - ワーカーユーザー: 「応募する」ボタン（jobs.apply へ遷移、次章で実装）
   - 企業ユーザー（自社求人のみ）: 「編集」ボタン（jobs.edit へ遷移）
   - 企業ユーザー（自社求人のみ）: 「削除」ボタン（削除確認モーダル表示）
 - **削除機能**:
   - 削除確認モーダル表示
   - 削除後は求人一覧（jobs.index）にリダイレクト
 - **ポリシー**: `view`アクション（誰でも閲覧可能）
 - **リレーション**:
   - company、location_idを先読み込み
 
 #### 募集登録画面
 - **ルート**: `GET /jobs/create`
 - **ルート名**: `jobs.create`
 - **コンポーネント**: `resources/views/livewire/jobs/create.blade.php`
 - **ミドルウェア**: `auth`, `role:company`
 - **機能**: 新規募集投稿
 - **入力項目**:
   - eyecatch: アイキャッチ画像（任意、画像アップロード）
   - howsoon: いつまでに（必須、ラジオボタン：いつか / いますぐにでも / ◯月までに、 "◯月までに"を選択しようとすると、「プロプランに変更してください」というバリデーションメッセージを表示）
   - job_title: やりたいこと（必須、日本語50文字以内、テキストエリア、"〇〇したい"とプレースホルダーで表示）
   - job_detail: 事業内容・困っていること（必須、日本語200文字以内、テキストエリア、"〇〇をしています。✕✕をやりたいが、△△なのでできていません"とプレースホルダーで表示）
   - job_type_id: 募集（必須、ラジオボタン、codesテーブルtype=1）
   - want_you_id: 希望（任意、チェックボックス、codesテーブルtype=2）
   - job_type_id: できます（任意、チェックボックス、codesテーブルtype=3）
 - **自動設定項目**:
   - company_id: ログインユーザーのID
   - posted_at: 現在日時
 - **バリデーション**（Form Request使用）:
   - job_title: required, max:50
   - job_detail: required, max:200
 - **UI**:
  - パソコン操作が苦手な事業者でもスマホで入力できるようにレスポンシブ対応する
 - **処理**:
   - バリデーション後、job_postsテーブルに登録
   - 登録成功後、求人一覧（jobs.index）にリダイレクト
 - **ポリシー**: `create`アクション（企業ユーザーのみ）
 
 #### 募集編集画面
 - **ルート**: `GET /jobs/{jobPost}/edit`
 - **ルート名**: `jobs.edit`
 - **コンポーネント**: `resources/views/livewire/jobs/edit.blade.php`
 - **ミドルウェア**: `auth`, `role:company`
 - **機能**: 既存求人の編集（自社求人のみ）
 - **入力項目**: 求人登録画面と同じ
 - **既存データ**: プリフィル（初期表示）
   - 勤務地は既存location_idから都道府県と市区町村を取得して表示
 - **posted_at**: 編集時は更新しない（既存値を保持）
 - **バリデーション**: 求人登録画面と同じ
 - **処理**:
   - バリデーション後、job_postsテーブルを更新
   - 更新成功後、求人詳細（jobs.show）にリダイレクト
 - **ポリシー**: `update`アクション（自社求人のみ）
 - **2段階選択の実装**:
   - 都道府県選択時に`wire:model.live="prefecture_id"`を使用
   - prefecture_idが変更されたら市区町村ドロップダウンを動的に更新
   - 市区町村はupdatedPrefectureId()メソッド内で絞り込み
   - mount時に既存のlocation_idから都道府県IDを取得してprefecture_idを設定
