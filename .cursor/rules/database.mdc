---
alwaysApply: true
---

# データベース設計

## データベース操作の原則
- Eloquent ORM使用必須
- 生のSQLクエリ使用禁止
- `DB::`ではなく`Model::query()`使用
- N+1問題への対策必須（先読み込み使用）
- リレーションシップメソッドに戻り値の型ヒント必須

## マイグレーション作成規則
- `sail artisan make:migration` 使用
- カラム変更時は以前の全属性を含める
- 適切なインデックス設定
- 外部キー制約の明示

### users（認証システムで自動作成済み）
- id
- name
- email
- password

### codesテーブル
**目的**: 募集形態・希望・できますのマスタデータ

**カラム定義**:
- id: bigint unsigned, primary key
- type: bigint, コード種類（type=0にコード種類の仕様を登録）
- type_id: bigint, コード種類ごとのID
- name: string(255), 表示名称
- description: text, nullable, 補足説明
- sort_order: integer, nullable, 表示順
- created_at, updated_at: timestamps

**インデックス**:
- PRIMARY: id

**リレーション**: なし

**コード種類一覧**:
- type=0: コード種類定義
- type=1: 募集形態
- type=2: 希望
- type=3: できます

コード種類定義（type=0）:
- type=0, type_id=1, name="雇用形態", sort_order=1
- type=0, type_id=2, name="希望", sort_order=2
- type=0, type_id=3, name="できます", sort_order=3

募集形態（type=1）:
- type=1, type_id=1, name="プロボノ(無償)", sort_order=1
- type=1, type_id=2, name="副業(有償)", sort_order=2
- type=1, type_id=3, name="採用(有償/雇用)", sort_order=3
- type=1, type_id=4, name="地域おこし協力隊", sort_order=4

希望（type=2）:
- type=2, type_id=1, name="若い人大歓迎", sort_order=1
- type=2, type_id=2, name="初めての人大歓迎", sort_order=2
- type=2, type_id=3, name="車を運転できる人", sort_order=3
- type=2, type_id=4, name="パソコンが得意な人", sort_order=4
- type=2, type_id=5, name="農業に興味がある人", sort_order=5
- type=2, type_id=6, name="お寺に興味がある人", sort_order=6
- type=2, type_id=7, name="音楽に興味がある人", sort_order=7
- type=2, type_id=8, name="お祭りに興味がある人", sort_order=8

できます（type=3）:
- type=3, type_id=1, name="車で迎えに行きます", sort_order=1
- type=3, type_id=2, name="お食事をご馳走します", sort_order=2
- type=3, type_id=3, name="お土産をあげます", sort_order=3
- type=3, type_id=4, name="体験ができます", sort_order=4

### job_postsテーブル

**目的**: お手伝い募集投稿の管理

**カラム定義**:
- id: bigint unsigned, primary key
- company_id: bigint unsigned, 外部キー（users.id）、企業ユーザーID
- eyecatch: string(255), nullable, アイキャッチ画像パス
- purpose: string(50), 募集目的（want_to_do=いつでも募集、need_help=決まった日に募集）
- start_datetime: datetime, nullable, 開始日時（決まった日に募集の場合のみ）
- end_datetime: datetime, nullable, 終了日時（決まった日に募集の場合のみ）
- job_title: string(50), やること
- job_detail: text, 具体的にはこんなことを手伝ってほしい（200文字以内）
- want_you_ids: json, nullable, こんな人に来てほしい（codesテーブルtype=2の配列）
- can_do_ids: json, nullable, できます（codesテーブルtype=3の配列）
- posted_at: datetime, 投稿日時
- created_at, updated_at: timestamps

**インデックス**:
- PRIMARY: id
- INDEX: company_id - 企業ごとの募集一覧取得を高速化
- INDEX: posted_at - 投稿日時順の一覧取得を高速化
- FOREIGN KEY: company_id (users.id) ON DELETE CASCADE

**リレーション**:
- users: 多対1（CASCADE削除） - 企業ユーザー
- job_applications: 1対多 - 応募情報

**募集目的の種類**:
- want_to_do: いつでも募集（開始日時・終了日時は不要）
- need_help: 決まった日に募集（開始日時・終了日時が必須）

**備考**:
- eyecatchはアップロード画像パスまたはプリセット画像パス（/images/presets/）
- purposeが'need_help'の場合、start_datetimeとend_datetimeが必須
- want_you_idsとcan_do_idsはJSON形式でIDの配列を保存
- job_detailは200文字制限

### job_applicationsテーブル

**目的**: 応募状況の記録

**カラム定義**:
- id: bigint unsigned, primary key
- job_id: bigint unsigned, 外部キー（job_posts.id）、募集情報
- worker_id: bigint unsigned, 外部キー（users.id）、ワーカーのユーザーID
- reasons: json, nullable, 応募理由（複数選択可、配列形式）
- motive: text, nullable, 応募メッセージ
- status: enum('applied', 'accepted', 'rejected', 'declined'), ステータス（applied=応募、accepted=承認、rejected=不承認、declined=辞退）
- applied_at: datetime, 応募日時
- judged_at: datetime, nullable, 採用判定日時（承認または不承認時）
- declined_at: datetime, nullable, 辞退日時
- created_at, updated_at: timestamps

**応募理由の選択肢（reasons）**:
- near_hometown: 地元の近く
- lived_before: 昔住んでいた地域
- wanted_to_visit: 行きたかった地域
- empathize_with_goal: やることに共感
- travel_opportunity: 旅のついで
- can_use_experience: 経験が活かせそう
- wanted_to_try: 自分もやってみたかった
- gain_new_experience: 新しい経験を積みたい

**インデックス**:
- PRIMARY: id
- UNIQUE: (job_id, worker_id) - 重複応募防止
- FOREIGN KEY: job_id (job_posts.id) ON DELETE RESTRICT
- FOREIGN KEY: worker_id (users.id) ON DELETE RESTRICT

**リレーション**:
- job_posts: 多対1（RESTRICT削除）
- users: 多対1（RESTRICT削除）

**備考**:
- (job_id, worker_id)に複合ユニーク制約を設定し、重複応募防止
- statusのデフォルト値は'applied'
- reasonsはJSON形式で複数の理由を配列として保存

### chat_roomsテーブル

**目的**: チャットルーム（1対1チャット）

**カラム定義**:
- id: bigint unsigned, primary key
- application_id: bigint unsigned, 外部キー（job_applications.id）、応募情報
- created_at, updated_at: timestamps

**インデックス**:
- PRIMARY: id
- UNIQUE: application_id - 1つの応募に1つのチャットルーム
- FOREIGN KEY: application_id (job_applications.id) ON DELETE CASCADE

**リレーション**:
- job_applications: 1対1（CASCADE削除）
- messages: 1対多（CASCADE削除）

**備考**:
- application_idにユニーク制約を設定し、1つの応募に1つのチャットルームを保証
- チャットルームは応募時に自動作成される

---

### messagesテーブル

**目的**: チャットメッセージ

**カラム定義**:
- id: bigint unsigned, primary key
- chat_room_id: bigint unsigned, 外部キー（chat_rooms.id）、チャットルーム
- sender_id: bigint unsigned, 外部キー（users.id）、送信者
- message: text, メッセージ内容
- is_read: boolean, 既読フラグ（デフォルト: false）
- created_at, updated_at: timestamps

**インデックス**:
- PRIMARY: id
- INDEX: chat_room_id - チャットルームごとのメッセージ取得を高速化
- FOREIGN KEY: chat_room_id (chat_rooms.id) ON DELETE CASCADE
- FOREIGN KEY: sender_id (users.id) ON DELETE RESTRICT

**リレーション**:
- chat_rooms: 多対1（CASCADE削除）
- users: 多対1（RESTRICT削除）

**備考**:
- is_readは受信者が既読にした時にtrueに更新
- created_atを送信日時として使用

<!-- ここから段階的に追加 -->
